# ============================================================
# NGINX CONFIGURATION - Frontend Container
# ============================================================
#
# This config does two important things:
#
# 1. SERVE THE REACT SPA:
#    React Router handles navigation on the client side.
#    Without "try_files", refreshing on /dashboard would 404
#    because Nginx doesn't know about React routes.
#    "try_files $uri $uri/ /index.html" always falls back to
#    index.html, letting React Router handle the routing.
#
# 2. PROXY /api REQUESTS TO THE BACKEND:
#    In development, Vite's dev server did the proxying.
#    In Docker, Nginx takes over this job.
#    Any request starting with /api is forwarded to the
#    "backend" service (defined in docker-compose.yml).
#    Docker's internal DNS resolves "backend" to the container's IP.
# ============================================================

server {
    listen 80;
    server_name localhost;

    # Root directory where Nginx serves files from
    root /usr/share/nginx/html;
    index index.html;

    # ── PROXY API REQUESTS TO BACKEND ────────────────────
    # Any request to /api/... gets forwarded to the backend container
    # "backend" is the Docker service name defined in docker-compose.yml
    # Docker automatically resolves it to the correct container IP
    location /api/ {
        proxy_pass http://backend:5000;

        # Standard proxy headers to pass client info to backend
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_cache_bypass $http_upgrade;
    }

    # ── SERVE REACT SPA ──────────────────────────────────
    # Try to serve the requested file directly.
    # If not found, fall back to index.html (React Router takes over).
    location / {
        try_files $uri $uri/ /index.html;
    }

    # ── CACHE STATIC ASSETS ──────────────────────────────
    # Tell browsers to cache JS/CSS/images for 1 year
    # Vite adds content hashes to filenames, so cache-busting is safe
    location ~* \.(js|css|png|jpg|jpeg|gif|svg|ico|woff|woff2)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }
}
